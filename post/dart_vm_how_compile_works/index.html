<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Dart VM源码分析之编译dill | 心在路上</title>
    <meta property="og:title" content="Dart VM源码分析之编译dill - 心在路上">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-09-12T20:37:39&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-09-12T20:37:39&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Dart VM源码分析之编译dill">
        
    <meta name="author" content="心在路上">
    <meta property="og:url" content="https://songchunbo.github.io/post/dart_vm_how_compile_works/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://songchunbo.github.io/">
                        心在路上
                    </a>
                
                <p class="description">专注于移动安全，虚拟机技术, Android沙箱，Android Framework, ART Runtime, Dart Runtime 病毒检测，逆向</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://songchunbo.github.io/">首页</a>
                    
                    <a  href="https://songchunbo.github.io/archives/" title="存档">存档</a>
                    
                    <a  href="https://songchunbo.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Dart VM源码分析之编译dill</h1>
        </header>
        <date class="post-meta meta-date">
            2021年9月12日
        </date>
        
        
        
        <div class="post-content">
            <h3 id="一dart-vm概述">一、Dart VM概述</h3>
<p>Dart VM是运行dart的虚拟机，由多个isolate组成，每个isolate提供dart的运行环境，类似ART中的Zygote提供的Java运行环境，Dart VM包含下面几个重要的isolate</p>
<ul>
<li>
<p>vm isolate</p>
<p>负责维持系统中基础的heap object如null,class_, true, false，供各个isolate共享</p>
</li>
<li>
<p>kernel isolate</p>
<p>主要用于执行CFE代码，CFE使用dart语言开发，实现了dart的语法分析，词法分析和语义分析，生成kernel AST并写入dill文件。</p>
</li>
<li>
<p>service isolate</p>
<p>主要用于执行其他isolate发起的service请求，service包括debug相关，compile相关等，具体列表：
<a href="https://github.com/dart-lang/sdk/blob/main/runtime/vm/service.cc#L5254">https://github.com/dart-lang/sdk/blob/main/runtime/vm/service.cc#L5254</a></p>
</li>
<li>
<p>dartdev isolate</p>
<p>主要用于执行用户命令，如dart run/compile等命令，最终会转换为后端命令。</p>
<pre><code>用户命令: dart compile kernel hello.dart 
 后端命令: dart --snapshot-kind=kernel --snapshot=hello.dill --verbosity=all hello.dart
</code></pre></li>
<li>
<p>main isolate</p>
<p>主要用来执行用户开发的dart code。</p>
</li>
</ul>
<p>更多关于Dart VM的基础原理可参见dart作者的blog，网上很多blog来自这篇文章，这篇文章还在持续完善中</p>
<p><a href="https://mrale.ph/dartvm/">https://mrale.ph/dartvm/</a></p>
<h3 id="二dart-vm各个isolate在main函数中的启动和初始化过程">二、Dart VM各个isolate在main函数中的启动和初始化过程</h3>
<ul>
<li>
<p>5个isolate在main中的初始化和启动过程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]) {
    Dart_Initialize(<span style="color:#f92672">&amp;</span>init_params) {
        Dart<span style="color:#f92672">::</span>Init(..) {
           Dart<span style="color:#f92672">::</span>DartInit(...) {
              <span style="color:#75715e">//各种初始化,线程池，heap,zone,object(null_,class_),stub code等
</span><span style="color:#75715e"></span>
              <span style="color:#75715e">// create_group_ = CreateIsolateGroupAndSetup();
</span><span style="color:#75715e"></span>              Isolate<span style="color:#f92672">::</span>SetCreateGroupCallback(create_group);
              <span style="color:#75715e">// 创建&#34;vm-isolate&#34; isolate
</span><span style="color:#75715e"></span>              vm_isolate_ <span style="color:#f92672">=</span> Isolate<span style="color:#f92672">::</span>InitIsolate(<span style="color:#e6db74">&#34;vm-isolate&#34;</span>, ....);

              <span style="color:#75715e">// 创建&#34;vm-service&#34; isolate
</span><span style="color:#75715e"></span>              <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>is_dart2_aot_precompiler <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>kDartPrecompiledRuntime) {
                  ServiceIsolate<span style="color:#f92672">::</span>Run(); {
                      CreateIsolateGroupAndSetup(<span style="color:#e6db74">&#34;vm-service&#34;</span>, ...)
                         CreateAndSetupServiceIsolate(<span style="color:#e6db74">&#34;vm-service&#34;</span>);
                  }
              }

              <span style="color:#75715e">// 初始化&#34;kernel-service&#34; isolate
</span><span style="color:#75715e"></span>              <span style="color:#66d9ef">if</span> (not dart precoompiled runtime) {
                  KernelIsolate<span style="color:#f92672">::</span>InitializeState();
              }

              <span style="color:#75715e">// 按需创建kernel-service isolate
</span><span style="color:#75715e"></span>              <span style="color:#75715e">// KernelIsolate::Start()
</span><span style="color:#75715e"></span>           }
        }
    }

    <span style="color:#75715e">// &#34;dartdev isolate&#34;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> should_run_user_program <span style="color:#f92672">=</span> true;
    <span style="color:#66d9ef">if</span> (...) {
        result <span style="color:#f92672">=</span> DartDevIsolate<span style="color:#f92672">::</span>RunDartDev(CreateIsolateGroupAndSetup,...)
           DartDevIsolate<span style="color:#f92672">::</span>DartDevRunner<span style="color:#f92672">::</span>Run(CreateIsolateGroupAndSetup,..)
             ThreadStart <span style="color:#f92672">--&gt;</span> DartDevRunner<span style="color:#f92672">::</span>RunCallback {
                 CreateIsolateGroupAndSetup(<span style="color:#e6db74">&#34;dartdev&#34;</span>);
                    CreateAndSetupDartDevIsolate(<span style="color:#e6db74">&#34;dartdev&#34;</span>)

                 <span style="color:#75715e">// dartdev isolate入口:
</span><span style="color:#75715e"></span>                 isolate_args[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dartdev.dart::main&#34;</span> <span style="color:#75715e">// entrypoint
</span><span style="color:#75715e"></span>                 isolate_args[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> args                 <span style="color:#75715e">// args
</span><span style="color:#75715e"></span>                 isolate_args[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> send_port;           <span style="color:#75715e">// message back
</span><span style="color:#75715e"></span>                 isolate_args[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> ...
                 ...

                 Dart_Invoke(isolate_lib<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dart::isolate&#34;</span>, <span style="color:#e6db74">&#34;_startIsolate&#34;</span>, <span style="color:#ae81ff">4</span>,
                               isolate_args);
                 Dart_RunLoop();
             }
        <span style="color:#75715e">// 如果dartdev命令结果是继续执行编译结果，则在main isolate中执行。
</span><span style="color:#75715e"></span>        should_run_user_program <span style="color:#f92672">=</span>
              (dartdev_result <span style="color:#f92672">==</span> DartDevIsolate<span style="color:#f92672">::</span>DartDev_Result_Run);
        <span style="color:#66d9ef">if</span> (should_run_user_program) {
            <span style="color:#75715e">// 加载编译后dill文件的data和instructions，包含app和vm的data和instruction
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// vm_snapshot_data
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// vm_snapshot_instructions
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// app_isolate_snapshot_data
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// app_isolate_snapshot_instructions
</span><span style="color:#75715e"></span>            try_load_snapshots_lambda();
        }
    }

    <span style="color:#75715e">// main isolate
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (should_run_user_program) {
        RunMainIsolate(script_name, ...)
          CreateIsolateGroupAndSetupHelper(true, <span style="color:#e6db74">&#34;hello.dart&#34;</span>, <span style="color:#e6db74">&#34;main&#34;</span>,...);

        <span style="color:#75715e">// 向kernel isolate发起编译dill binary请求
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (Options<span style="color:#f92672">::</span>gen_snapshot_kind) <span style="color:#f92672">==</span> kKernel) {
           Snapshot<span style="color:#f92672">::</span>GenerateKernel(Options<span style="color:#f92672">::</span>snapshot_filename(), script_name..)
        }
        <span style="color:#75715e">// load dill binary(try_load_snapshots_lambda)，并执行
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> {
            isolate_args[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello.dart::main&#34;</span>;   <span style="color:#75715e">// entrypoint
</span><span style="color:#75715e"></span>            isolate_args[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span>  args                 <span style="color:#75715e">// args
</span><span style="color:#75715e"></span>
            Dart_Invoke(isolate_lib<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dart::isolate&#34;</span>, <span style="color:#ae81ff">2</span>, isolate_args);
            Dart_RunLoop();
            <span style="color:#75715e">// Generate an app snapshot after execution if specified.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (Options<span style="color:#f92672">::</span>gen_snapshot_kind() <span style="color:#f92672">==</span> kAppJIT) {
                Snapshot<span style="color:#f92672">::</span>GenerateAppJIT(Options<span style="color:#f92672">::</span>snapshot_filename());
            }
        }

    }
}
</code></pre></div></li>
</ul>
<h3 id="二-用户命令dart-compile-kernel-hellodart执行过程">二、 用户命令dart compile kernel hello.dart执行过程</h3>
<ul>
<li>
<p>用户命令在dartdev isolate中执行</p>
<p>dartdev isolate入口在dartdev.dart，dartdev.dart是一个dart开发工具包，可以处理各种用户命令，包括analyzer, create, compile, run等命令</p>
<p><a href="https://github.com/dart-lang/sdk/blob/main/pkg/dartdev/bin/dartdev.dart">https://github.com/dart-lang/sdk/blob/main/pkg/dartdev/bin/dartdev.dart</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 支持的命令 
</span><span style="color:#75715e"></span><span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">AnalyzeCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">CreateCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">CompileCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">FixCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">FormatCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">LanguageServerCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">MigrateCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">pubCommand</span>());
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">RunCommand</span>(<span style="color:#a6e22e">verbose</span>: <span style="color:#a6e22e">verbose</span>));
<span style="color:#a6e22e">addCommand</span>(<span style="color:#a6e22e">TestCommand</span>())
</code></pre></div></li>
<li>
<p>dartdev入口，以及调用流程</p>
<ol>
<li>The entry point for dartdev</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">Future</span>&lt;<span style="color:#a6e22e">void</span>&gt; <span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">List</span>&lt;<span style="color:#a6e22e">String</span>&gt;<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">SendPort</span> )
    <span style="color:#a6e22e">runDartdev</span>(<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">port</span>)
       <span style="color:#a6e22e">DartdevRunner</span>.<span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">args</span>)
          <span style="color:#a6e22e">DartdevRunner</span>::<span style="color:#a6e22e">runCommand</span>(<span style="color:#a6e22e">args</span>)
             <span style="color:#a6e22e">super</span>.<span style="color:#a6e22e">runCommand</span>(<span style="color:#a6e22e">args</span>)
                <span style="color:#a6e22e">CompileCommand</span>.<span style="color:#a6e22e">runCommand</span>(..)
</code></pre></div><ol start="2">
<li>CompileComand有四个子命令进行js，aot，exe，jit编译</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">CompileCommand</span>.<span style="color:#a6e22e">runCommand</span>(..)
    <span style="color:#a6e22e">CompileSnapshotCommand</span>.<span style="color:#a6e22e">run</span> {
       <span style="color:#75715e">// Compiling hello.dart to kernel file hello.dill
</span><span style="color:#75715e"></span>       <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">stdout</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Compiling</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">sourcePath</span> <span style="color:#a6e22e">to</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">commandName</span> <span style="color:#a6e22e">file</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">outputFile</span>.<span style="color:#960050;background-color:#1e0010">&#39;</span>);
       <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">startDartProcess</span>(<span style="color:#a6e22e">sdk</span>, <span style="color:#a6e22e">args</span>);
          <span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">start</span>(<span style="color:#a6e22e">sdk</span>.<span style="color:#a6e22e">dart</span>, <span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">workingDirectory</span>: <span style="color:#a6e22e">cwd</span>);
          <span style="color:#75715e">//调用native函数dart::bin::Builtin_Process_Start()
</span><span style="color:#75715e"></span>          <span style="color:#75715e">//最终会fork出一个子进程，执行dart编译命令
</span><span style="color:#75715e"></span>    }

   .<span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">Builtin_Process_Start调用栈如下</span><span style="color:#960050;background-color:#1e0010">：</span>

<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>  <span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">ProcessStarter</span>::<span style="color:#a6e22e">ProcessStarter</span> (<span style="color:#a6e22e">this</span>=<span style="color:#ae81ff">0x7ffff39fde38</span>, <span style="color:#a6e22e">namespc</span>=<span style="color:#ae81ff">0x555558973740</span>,
    <span style="color:#a6e22e">path</span>=<span style="color:#ae81ff">0x5555589ed180</span> <span style="color:#e6db74">&#34;/data/chunbo/aosp/dart-sdk/sdk/out/DebugX64/dart-sdk/bin/dartdebug&#34;</span>, <span style="color:#a6e22e">arguments</span>=<span style="color:#ae81ff">0x5555589ed210</span>,
    <span style="color:#a6e22e">arguments_length</span>=<span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">working_directory</span>=<span style="color:#ae81ff">0x0</span>, <span style="color:#a6e22e">environment</span>=<span style="color:#ae81ff">0x5555589ed3c0</span>, <span style="color:#a6e22e">environment_length</span>=<span style="color:#ae81ff">31</span>, <span style="color:#a6e22e">mode</span>=<span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">kNormal</span>,
    <span style="color:#a6e22e">in</span>=<span style="color:#ae81ff">0x7ffff39fe068</span>, <span style="color:#a6e22e">out</span>=<span style="color:#ae81ff">0x7ffff39fe070</span>, <span style="color:#a6e22e">err</span>=<span style="color:#ae81ff">0x7ffff39fe060</span>, <span style="color:#a6e22e">id</span>=<span style="color:#ae81ff">0x7ffff39fdfc0</span>, <span style="color:#a6e22e">exit_event</span>=<span style="color:#ae81ff">0x7ffff39fe058</span>,
    <span style="color:#a6e22e">os_error_message</span>=<span style="color:#ae81ff">0x7ffff39fdfb8</span>) <span style="color:#a6e22e">at</span> ..<span style="color:#f92672">/</span>..<span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">process_linux</span>.<span style="color:#a6e22e">cc</span>:<span style="color:#ae81ff">270</span>
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0x000055555748a5b9</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">Process</span>::<span style="color:#a6e22e">Start</span> (<span style="color:#a6e22e">namespc</span>=<span style="color:#ae81ff">0x555558973740</span>,
    <span style="color:#a6e22e">path</span>=<span style="color:#ae81ff">0x5555589ed180</span> <span style="color:#e6db74">&#34;/data/chunbo/aosp/dart-sdk/sdk/out/DebugX64/dart-sdk/bin/dartdebug&#34;</span>, <span style="color:#a6e22e">arguments</span>=<span style="color:#ae81ff">0x5555589ed210</span>,
    <span style="color:#a6e22e">arguments_length</span>=<span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">working_directory</span>=<span style="color:#ae81ff">0x0</span>, <span style="color:#a6e22e">environment</span>=<span style="color:#ae81ff">0x5555589ed3c0</span>, <span style="color:#a6e22e">environment_length</span>=<span style="color:#ae81ff">31</span>, <span style="color:#a6e22e">mode</span>=<span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">kNormal</span>,
    <span style="color:#a6e22e">in</span>=<span style="color:#ae81ff">0x7ffff39fe068</span>, <span style="color:#a6e22e">out</span>=<span style="color:#ae81ff">0x7ffff39fe070</span>, <span style="color:#a6e22e">err</span>=<span style="color:#ae81ff">0x7ffff39fe060</span>, <span style="color:#a6e22e">id</span>=<span style="color:#ae81ff">0x7ffff39fdfc0</span>, <span style="color:#a6e22e">exit_event</span>=<span style="color:#ae81ff">0x7ffff39fe058</span>,
    <span style="color:#a6e22e">os_error_message</span>=<span style="color:#ae81ff">0x7ffff39fdfb8</span>) <span style="color:#a6e22e">at</span> ..<span style="color:#f92672">/</span>..<span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">process_linux</span>.<span style="color:#a6e22e">cc</span>:<span style="color:#ae81ff">809</span>
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0x0000555557489688</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">Builtin_Process_Start</span> (<span style="color:#a6e22e">args</span>=<span style="color:#ae81ff">0x7ffff39fe1a0</span>) <span style="color:#a6e22e">at</span> ..<span style="color:#f92672">/</span>..<span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">cc</span>:<span style="color:#ae81ff">144</span>
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">0x00005555577dd42c</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">NativeEntry</span>::<span style="color:#a6e22e">AutoScopeNativeCallWrapperNoStackCheck</span> (<span style="color:#a6e22e">args</span>=<span style="color:#ae81ff">0x7ffff39fe1a0</span>,
    <span style="color:#66d9ef">func</span>=<span style="color:#ae81ff">0x555557489300</span> &lt;<span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">Builtin_Process_Start</span>(<span style="color:#a6e22e">_Dart_NativeArguments</span><span style="color:#f92672">*</span>)&gt;) <span style="color:#a6e22e">at</span> ..<span style="color:#f92672">/</span>..<span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">vm</span><span style="color:#f92672">/</span><span style="color:#a6e22e">native_entry</span>.<span style="color:#a6e22e">cc</span>:<span style="color:#ae81ff">217</span>
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">0x00005555577dd309</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">NativeEntry</span>::<span style="color:#a6e22e">AutoScopeNativeCallWrapper</span> (<span style="color:#a6e22e">args</span>=<span style="color:#ae81ff">0x7ffff39fe1a0</span>,
    <span style="color:#66d9ef">func</span>=<span style="color:#ae81ff">0x555557489300</span> &lt;<span style="color:#a6e22e">dart</span>::<span style="color:#a6e22e">bin</span>::<span style="color:#a6e22e">Builtin_Process_Start</span>(<span style="color:#a6e22e">_Dart_NativeArguments</span><span style="color:#f92672">*</span>)&gt;) <span style="color:#a6e22e">at</span> ..<span style="color:#f92672">/</span>..<span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">vm</span><span style="color:#f92672">/</span><span style="color:#a6e22e">native_entry</span>.<span style="color:#a6e22e">cc</span>:<span style="color:#ae81ff">198</span>
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">0x00007ffff7682a44</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">6</span>  <span style="color:#ae81ff">0x00005555589b1000</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">0x000000000100000c</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">0x00007ffff39fe240</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">9</span>  <span style="color:#ae81ff">0x00007ffff39fe1e0</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">10</span> <span style="color:#ae81ff">0x00007ffff3472c21</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">11</span> <span style="color:#ae81ff">0x00007ffff778d501</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">12</span> <span style="color:#ae81ff">0x00007ffff39fe268</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">13</span> <span style="color:#ae81ff">0x00007ffff3b2b164</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">14</span> <span style="color:#ae81ff">0x00007ffff7788041</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">0x00007ffff3af1639</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#ae81ff">0x00007ffff3aed079</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">0x00007ffff3aec7d9</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">0x00007ffff3aebf59</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">19</span> <span style="color:#ae81ff">0x00007ffff3aea2b9</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#a6e22e">in</span> <span style="color:#960050;background-color:#1e0010">??</span> ()
</code></pre></div><ol start="3">
<li>fork的子进程会实际执行编译动作</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">CMD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$DART_BIN/dart --snapshot-kind=kernel --snapshot=hello.dill --verbosity=all $DART_SOURCE/hello.dart</span>
dart<span style="color:#f92672">::</span>bin<span style="color:#f92672">::</span>Builtin_Process_Start(...)
  ....
  dart<span style="color:#f92672">::</span>bin<span style="color:#f92672">::</span>ProcessStarter starter(namespc, path, arguments, arguments_length,...)
  starter.Start() {
      pid_t pid <span style="color:#f92672">=</span> fork();
      <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
          NewProcess()
             ExecProcess(){
                <span style="color:#75715e">// CMD=&#34;$DART_BIN/dart --snapshot-kind=kernel --snapshot=hello.dill ....
</span><span style="color:#75715e"></span>                execvp(realpath, <span style="color:#66d9ef">const_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*&gt;</span>(program_arguments_));
             }

      }
  }
</code></pre></div></li>
</ul>
<h3 id="三-转换后的dart命令执行流程">三、 转换后的dart命令执行流程</h3>
<ul>
<li>
<pre><code>dart --snapshot-kind=kernel --snapshot=hello.dill --verbosity=all hello.dart
</code></pre></li>
<li>
<p>在main isolate中启动kernel isolate(CFE)并初始化，同时向kernel isolate发起编译请求，把生成的AST写入dill文件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]) {
    ...
    RunMainIsolate(script_name, package_config_override, <span style="color:#f92672">&amp;</span>dart_options) {
        <span style="color:#66d9ef">if</span> (Options<span style="color:#f92672">::</span>gen_snapshot_kind() <span style="color:#f92672">==</span> kKernel) {
<span style="display:block;width:100%;background-color:#3c3d38">            Snapshot<span style="color:#f92672">::</span>GenerateKernel(Options<span style="color:#f92672">::</span>snapshot_filename(), script_name, ..) {
</span>                dfe.ReadScript(script_name, kernel_buffer,..);
                <span style="color:#66d9ef">if</span> (kernel_buffer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
                    WriteSnapshotFile(snapshot_filename, kernel_buffer,..);
                } <span style="color:#66d9ef">else</span> {
                    <span style="color:#75715e">// 向kernel isolate(CFE)发起dart编译请求
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                    Dart_KernelCompilationResult result <span style="color:#f92672">=</span>
</span><span style="display:block;width:100%;background-color:#3c3d38">                         dfe.CompileScript(script_name, false, package_config, true);
</span>
                    <span style="color:#75715e">// 请求成功后把编译结果写入dill文件
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                    WriteSnapshotFile(snapshot_filename, result.kernel, result.kernel_size);
</span>                }
            }
        }
    }
}
</code></pre></div></li>
<li>
<p>启动kernel isolate，向kernel isolate CFE模块发起dart编译请求</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"> dfe.CompileScript(script_name, false, package_config, true);
   Dart_CompileToKernel(sanitized_uri, platform_strong_dill,platform_strong_dill_size,...);
      KernelIsolate<span style="color:#f92672">::</span>CompileToKernel(script_uri, platform_kernel, platform_kernel_size,..) {
          <span style="color:#75715e">// Start the kernel Isolate if it is not already running.
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>KernelIsolate<span style="color:#f92672">::</span>Start()) {
</span>          }

          <span style="color:#75715e">// This must be the main script to be loaded. Wait for Kernel isolate
</span><span style="color:#75715e"></span>          <span style="color:#75715e">// to finish initialization.
</span><span style="color:#75715e"></span>          Dart_Port kernel_port <span style="color:#f92672">=</span> WaitForKernelPort();  <span style="color:#75715e">// kernel_service.dart
</span><span style="color:#75715e"></span>
          KernelCompilationRequest request;
          <span style="color:#75715e">// 向kernel isolate发起编译请求
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>          <span style="color:#66d9ef">return</span> request.SendAndWaitForResponse(
</span><span style="display:block;width:100%;background-color:#3c3d38">              kCompileTag, kernel_port, script_uri, platform_kernel,
</span><span style="display:block;width:100%;background-color:#3c3d38">              platform_kernel_size, source_file_count, source_files,
</span><span style="display:block;width:100%;background-color:#3c3d38">              incremental_compile, snapshot_compile, package_config,
</span><span style="display:block;width:100%;background-color:#3c3d38">              multiroot_filepaths, multiroot_scheme, experimental_flags_, NULL,
</span><span style="display:block;width:100%;background-color:#3c3d38">              verbosity);
</span>
      }

</code></pre></div></li>
<li>
<p>kernel isolate启动和初始化</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"> KernelIsolate<span style="color:#f92672">::</span>Start() {
      Dart<span style="color:#f92672">::</span>thread_pool()<span style="color:#f92672">-&gt;</span>Run<span style="color:#f92672">&lt;</span>RunKernelTask<span style="color:#f92672">&gt;</span>();
         <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">thread</span><span style="color:#f92672">::</span>RunKernelTask<span style="color:#f92672">::</span>run() {
              create_group_callback <span style="color:#f92672">=</span> KernelIsolate<span style="color:#f92672">::</span>create_group_callback() <span style="color:#75715e">// CreateIsolateGroupAndSetup;
</span><span style="color:#75715e"></span>              CreateIsolateGroupAndSetup(<span style="color:#e6db74">&#34;kernel-service&#34;</span>, ..)
                CreateAndSetupKernelIsolate(<span style="color:#e6db74">&#34;kernel-service&#34;</span>, ..)
                  IsolateSetupHelper(...)
                      <span style="color:#75715e">// 加载kernel-service的dart code
</span><span style="color:#75715e"></span>                      <span style="color:#75715e">// 332	  if (isolate_run_app_snapshot) {
</span><span style="color:#75715e"></span>                      <span style="color:#75715e">// (gdb) n
</span><span style="color:#75715e"></span>                      <span style="color:#75715e">// 333	    Dart_Handle result = Loader::InitForSnapshot(script_uri, isolate_data);
</span><span style="color:#75715e"></span>                      <span style="color:#75715e">// (gdb) p script_uri
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                      <span style="color:#75715e">// $2 = 0x55555896e3c0 &#34;/data/chunbo/aosp/dart-sdk/sdk/out/DebugX64/dart-sdk/bin/snapshots/kernel-service.dart.snapshot&#34;
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                      <span style="color:#66d9ef">if</span> (isolate_run_app_snapshot) {
</span><span style="display:block;width:100%;background-color:#3c3d38">                         Dart_Handle result <span style="color:#f92672">=</span> Loader<span style="color:#f92672">::</span>InitForSnapshot(script_uri, isolate_data)
</span>                      }
      <span style="color:#75715e">// 执行kernel isolate的入口函数
</span><span style="color:#75715e"></span>      RunMain(isolate);
<span style="display:block;width:100%;background-color:#3c3d38">         DartEntry<span style="color:#f92672">::</span>InvokeFunction(<span style="color:#e6db74">&#34;kernel_service.dart::main&#34;</span>, empty args);
</span>         <span style="color:#75715e">// kernel_service.dart
</span><span style="color:#75715e"></span>           main([args]) {
               <span style="color:#66d9ef">if</span> ((args<span style="color:#f92672">?</span>.length <span style="color:#f92672">??</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> args[<span style="color:#ae81ff">0</span>]....) {
               } <span style="color:#66d9ef">else</span> {
              <span style="color:#75715e">// Entry point for the Kernel isolate.
</span><span style="color:#75715e"></span>                   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RawReceivePort</span>()..handler <span style="color:#f92672">=</span> _processLoadRequest;    
               }
           }

  }
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>kernel isolate接收来自的main isolate的编译请求</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">// kernel_service.dart
</span><span style="color:#75715e"></span>main([args]) {
  <span style="color:#66d9ef">if</span> ((args<span style="color:#f92672">?</span>.length <span style="color:#f92672">??</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> args[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">--</span>train<span style="color:#960050;background-color:#1e0010">&#39;</span>) {
    <span style="color:#75715e">// This entry point is used when creating an app snapshot.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// It takes the following extra arguments:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 1) Script to compile.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 2) Optional platform kernel path.
</span><span style="color:#75715e"></span>    train(script, platform);
       trainInternal(scriptUri, platformKernelPath);
          _processLoadRequest(request)
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#75715e">// Entry point for the Kernel isolate.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RawReceivePort</span>()..handler <span style="color:#f92672">=</span> _processLoadRequest;
  }
}
</code></pre></div></li>
<li>
<p>编译dart code，词法分析，语法分析和语义分析并返回结果给main isolate</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">_processLoadRequest(request) {
    Compiler<span style="color:#f92672">?</span> compiler;
    <span style="color:#66d9ef">if</span> (incremental) {
       compiler <span style="color:#f92672">=</span> await lookupOrBuildNewIncrementalCompiler(..)
    } <span style="color:#66d9ef">else</span> {
       compiler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SingleShotCompilerWrapper(..);
    }
    CompilerResult compilerResult <span style="color:#f92672">=</span> await compiler.compile(script<span style="color:#f92672">!</span>);
       SingleShotCompilerWrapper<span style="color:#f92672">::</span>compileInternal(Uri script) async 
          kernelForProgram(Uri source, ..)
            kernelForProgramInternal(source, ...);
            ....
}
</code></pre></div></li>
<li>
<p>main isolate收到编译好的Kernel AST写入dill文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]) {
    ...
    RunMainIsolate(script_name, package_config_override, <span style="color:#f92672">&amp;</span>dart_options) {
        <span style="color:#66d9ef">if</span> (Options<span style="color:#f92672">::</span>gen_snapshot_kind() <span style="color:#f92672">==</span> kKernel) {
<span style="display:block;width:100%;background-color:#3c3d38">            Snapshot<span style="color:#f92672">::</span>GenerateKernel(Options<span style="color:#f92672">::</span>snapshot_filename(), script_name, ..) {
</span>                dfe.ReadScript(script_name, kernel_buffer,..);
                <span style="color:#66d9ef">if</span> (kernel_buffer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
                    WriteSnapshotFile(snapshot_filename, kernel_buffer,..);
                } <span style="color:#66d9ef">else</span> {
                    <span style="color:#75715e">// 向kernel isolate(CFE)发起dart编译请求
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                    Dart_KernelCompilationResult result <span style="color:#f92672">=</span>
</span><span style="display:block;width:100%;background-color:#3c3d38">                         dfe.CompileScript(script_name, false, package_config, true);
</span>
                    <span style="color:#75715e">// 请求成功后把编译结果写入dill文件
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>                    WriteSnapshotFile(snapshot_filename, result.kernel, result.kernel_size);
</span>                }
            }
        }
    }
}
</code></pre></div><p><strong>至此dill的编译流程结束，下篇会介绍下CFE的编译过程</strong></p>
</li>
</ul>

        </div>

        


        


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "Songchunbo/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://songchunbo.github.io/">心在路上 By 心在路上</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://songchunbo.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://songchunbo.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://songchunbo.github.io/post/dart_vm_how_compile_works/" title="Dart VM源码分析之编译dill">Dart VM源码分析之编译dill</a>
    </li>
    
    <li>
        <a href="https://songchunbo.github.io/post/dart_vm_quick_start/" title="Dart VM命令行工具">Dart VM命令行工具</a>
    </li>
    
    <li>
        <a href="https://songchunbo.github.io/post/x86_arm_callconvention/" title="X86 and ARM Call Convention">X86 and ARM Call Convention</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://android.googlesource.com/" title="AOSP">AOSP</a>
        </li>
        
        <li>
            <a target="_blank" href="https://android.googlesource.com/platform/art/" title="ART mirror">ART mirror</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://songchunbo.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>